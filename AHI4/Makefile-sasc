#
# This file is part of the AmiGUS.audio driver.
#
# AmiGUS.audio driver is free software: you can redistribute it and/or modify
# it under the terms of the GNU Lesser General Public License as published by
# the Free Software Foundation, version 3 of the License only.
#
# AmiGUS.audio driver is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU LesserGeneral Public License for more details.
#
# You should have received a copy of the GNU Lesser General Public License
# along with AmiGUS.audio driver.  If not, see <http://www.gnu.org/licenses/>.
#

DDIR   = target/
BDIR   = build/
SDIR   = src/
HDIR   = header/

AHI_INCLUDE     = include
NDK_ASM_INCLUDE = NDKasmInclude:

MODE_FILE_DST   = $(DDIR)AMIGUS
MODE_FILE_SRC   = $(SDIR)audiomodes.asm
MODE_FILE_ASM   = vasmm68k_mot
MODE_FILE_FLAGS = -quiet -phxass -I$(NDK_ASM_INCLUDE) -I$(AHI_INCLUDE)/Asm -Fbin

LIB_DST         = $(DDIR)AmiGUS.audio
LIB_OBJS        = $(BDIR)libinit.o \
                  $(BDIR)amigus.o \
                  $(BDIR)debug.o \
                  $(BDIR)support.o \
                  $(BDIR)worker.o
CFLAGS          = RESOPT PARM=R NOSTKCHK STRMER UCHAR NOCHKABORT NOICONS \
                  DATA=FO CODE=FAR DEFINE=__NOLIBBASE__                  \
                  IDIR=$(AHI_INCLUDE)/C IDIR=$(HDIR)                     \
                  OPT OPTINLOCAL OPTGO OPTLOOP OPTPEEP OPTSCHED          \
                  OBJNAME

YYYYYYYYYYY     = cc
XXXXXXXXXXX     = PARAMS=REGISTER LIBCODE NOSTACKCHECK DEBUG=FULL STRINGMERGE \
                  DATA=NEAR NOVERSION UTILITYLIB NOSTANDARDIO OPTIMIZE        \
                  OPTTIME OPTSCHED IDIR=$(AHI_INCLUDE)/C IDIR=$(HDIR)        \
                  OBJNAME

#-O2 -c -I$(AHI_INCLUDE)/C -I$(HDIR) -D__NOLIBBASE__ -o
LFLAGS          = NOICONS SMALLDATA SMALLCODE STRIPDEBUG \
                  TO 
# -nostdlib -o 
LFLAGS1         = FROM
# empty :)

CC              = sc
LD              = slink

all: FOLDERS $(MODE_FILE_DST) $(LIB_DST)

$(MODE_FILE_DST): $(MODE_FILE_SRC)
	$(MODE_FILE_ASM) $(MODE_FILE_FLAGS) $^ -o $@
#	basm -ua+ -o$@ $(SDIR)audiomodes.basm

$(LIB_DST): $(LIB_OBJS)
	$(LD) $(LFLAGS) $@ $(LFLAGS1) $^
	
$(BDIR)libinit.o: $(SDIR)libinit.c $(HDIR)amigus_private.h
	$(CC) $(CFLAGS) $@ $<

$(BDIR)amigus.o: $(SDIR)amigus.c $(HDIR)amigus_private.h
	$(CC) $(CFLAGS) $@ $<

$(BDIR)debug.o: $(SDIR)debug.c $(HDIR)debug.h
	$(CC) $(CFLAGS) $@ $<

$(BDIR)support.o: $(SDIR)support.c $(HDIR)support.h
	$(CC) $(CFLAGS) $@ $<

$(BDIR)worker.o: $(SDIR)worker.c
	$(CC) $(CFLAGS) $@ $<

install: all
	copy FROM $(MODE_FILE_DST)     	TO	Devs:AudioModes/	CLONE 
	copy FROM $(LIB_DST)	TO	Devs:AHI/		CLONE
	avail flush >NIL:
#	tools/FlushLibs
#	AddAudioModes devs:AudioModes/AMIGUS

INCLUDES:
	make -f Makefile-Includes all 

FOLDERS:
	-@makedir $(DDIR) ALL >NIL:
	-@makedir $(BDIR) ALL >NIL:

clean:
	-delete $(DDIR) $(BDIR) ALL >NIL:

dist-clean: clean
	make -f Makefile-Includes clean
